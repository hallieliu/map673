<!DOCTYPE html>
<html>

<head>

    <meta charset=utf-8 />
    <title>Kenyan Household Energy Sources</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />
    <script src='https://code.jquery.com/jquery-1.12.0.min.js'></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>

    <style>
        body {
            margin: 0;
            padding: 0;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        
        #ui-slider {
            position: absolute;
            top: 20px;
            left: 60px;
        }
    </style>

</head>

<body>

    <div id='map'></div>
    <div id="ui-slider">
        <input type="range" min=".1" , max="1" , value=".6" , step=".1" class="slider">
    </div>

    <script>
        L.mapbox.accessToken = 'pk.eyJ1IjoiaGFsbGllbGl1IiwiYSI6ImNpbnFhMGQwNDAwZWZ3N2tsMjMxa3RxNGkifQ.dJnzRSGnzwTOJduI5IEeJA';

        var map = L.mapbox.map('map', 'mapbox.light', {
            center: [-.23, 37.8],
            zoom: 6,
            minZoom: 6,
            maxZoom: 9,
            maxBounds: L.latLngBounds([-6.22, 27.72], [5.76, 47.83])
        });

        var energyCategories = [
            'electricity',
            'p_lamp',
            'lantern',
            'tin_lamp',
            'gas_lamp',
            'wood',
            'solar',
            'other'
        ],
            radiusMultiplier = .6,
            electricity,
            p_lamp,
            lantern,
            tin_lamp,
            gas_lamp,
            wood,
            solar,
            other;

        //var counties = omnivore.geojson('population-kenya-counties-2009.geojson').addTo(map);
        var energy = omnivore.csv('lighting-energy-kenya-counties-2009.csv')
            .on('ready', function (e) {
                drawMap(e.target.toGeoJSON())
            })
            .on('error', function (e) {
                console.log(e.error[0].message);
            });
        //.addTo(map);      ****** the drawMap() function now adds the data to the map *****

        //console.log(energy);
        
        sequenceUI();



        function drawMap(energyData) {

            electricity = L.geoJson(energyData, {
                pointToLayer: function (feature, layer) {
                    return L.circleMarker(layer, {
                        color: '#D96D02',
                        opacity: 1,
                        weight: 2,
                        fillOpacity: 0,
                        //radius: calcRadius(Number(feature.properties.electricity))
                    });
                }
            }).addTo(map);

             p_lamp = L.geoJson(energyData, {
                pointToLayer: function (feature, layer) {
                    return L.circleMarker(layer, {
                        color: '#1cce58',
                        opacity: 1,
                        weight: 2,
                        fillOpacity: 0,
                        //radius: calcRadius(Number(feature.properties.p_lamp))
                    });
                }
            }).addTo(map);

             lantern = L.geoJson(energyData, {
                pointToLayer: function (feature, layer) {
                    return L.circleMarker(layer, {
                        color: '#1d198d',
                        opacity: 1,
                        weight: 2,
                        fillOpacity: 0,
                        //radius: calcRadius(Number(feature.properties.lantern))
                    });
                }
            }).addTo(map);

             tin_lamp = L.geoJson(energyData, {
                pointToLayer: function (feature, layer) {
                    return L.circleMarker(layer, {
                        color: '#a0408d',
                        opacity: 1,
                        weight: 2,
                        fillOpacity: 0,
                        //radius: calcRadius(Number(feature.properties.tin_lamp))
                    });
                }
            }).addTo(map);

             gas_lamp = L.geoJson(energyData, {
                pointToLayer: function (feature, layer) {
                    return L.circleMarker(layer, {
                        color: '#cf4c1f',
                        opacity: 1,
                        weight: 2,
                        fillOpacity: 0,
                        //radius: calcRadius(Number(feature.properties.gas_lamp))
                    });
                }
            }).addTo(map);

            wood = L.geoJson(energyData, {
                pointToLayer: function (feature, layer) {
                    return L.circleMarker(layer, {
                        color: '#3b7326',
                        opacity: 1,
                        weight: 2,
                        fillOpacity: 0,
                        //radius: calcRadius(Number(feature.properties.wood))
                    });
                }
            }).addTo(map);

             solar = L.geoJson(energyData, {
                pointToLayer: function (feature, layer) {
                    return L.circleMarker(layer, {
                        color: '#e6ab02',
                        opacity: 1,
                        weight: 2,
                        fillOpacity: 0,
                        //radius: calcRadius(Number(feature.properties.Solar))
                    });
                }
            }).addTo(map);

            other = L.geoJson(energyData, {
                pointToLayer: function (feature, layer) {
                    return L.circleMarker(layer, {
                        color: '#1a7acc',
                        opacity: 1,
                        weight: 2,
                        fillOpacity: 0,
                        //radius: calcRadius(Number(feature.properties.other))
                    });
                }
            }).addTo(map);

            updateSymbols();

            //console.log(energyData);
        }

        function calcRadius(val) {
            var radius = Math.sqrt(val / Math.PI);
            return radius * radiusMultiplier;
        }

        function updateSymbols() {

            electricity.eachLayer(function (layer) {
                layer.setRadius(calcRadius(Number(layer.feature.properties.electricity)));
            });

            p_lamp.eachLayer(function (layer) {
                layer.setRadius(calcRadius(Number(layer.feature.properties.p_lamp)));
            });

            lantern.eachLayer(function (layer) {
                layer.setRadius(calcRadius(Number(layer.feature.properties.lantern)));
            });

            tin_lamp.eachLayer(function (layer) {
                layer.setRadius(calcRadius(Number(layer.feature.properties.tin_lamp)));
            });

            gas_lamp.eachLayer(function (layer) {
                layer.setRadius(calcRadius(Number(layer.feature.properties.gas_lamp)));
            });

            wood.eachLayer(function (layer) {
                layer.setRadius(calcRadius(Number(layer.feature.properties.wood)));
            });

            solar.eachLayer(function (layer) {
                layer.setRadius(calcRadius(Number(layer.feature.properties.Solar)));
            });

            other.eachLayer(function (layer) {
                layer.setRadius(calcRadius(Number(layer.feature.properties.other)));
            });
        }

        function sequenceUI() {

            $('.slider')
                .on('input change', function () {
                    radiusMultiplier = $(this).val();
                    updateSymbols();
                });
        }
    </script>

</body>

</html>