<!DOCTYPE html>
<html>

<head>

    <meta charset=utf-8 />
    <title>Kenyan Household Energy Sources</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />
    <script src='https://code.jquery.com/jquery-1.12.0.min.js'></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/1.0.1/simple_statistics.min.js'></script>

    <style>
        body {
            margin: 0;
            padding: 0;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        
        #ui-slider {
            position: absolute;
            top: 20px;
            left: 60px;
        }
        
        #multiplier {
            position: absolute;
            left: 60px;
            top: 50px;
            padding: 6px 15px 8px;
            background: whitesmoke;
            border: 2px solid #d3d3d3;
        }
        
        #legend {
            position: absolute;
            right: 0;
            bottom: 30px;
        }
        
        .menu-ui {
            background: #fff;
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
            border-radius: 3px;
            width: 120px;
            border: 1px solid rgba(0, 0, 0, 0.4);
        }
        
        .menu-ui a {
            font-size: 13px;
            color: #404040;
            display: block;
            margin: 0;
            padding: 0;
            padding: 10px;
            text-decoration: none;
            border-bottom: 1px solid rgba(0, 0, 0, 0.25);
            text-align: center;
        }
        
        .menu-ui a:first-child {
            border-radius: 3px 3px 0 0;
        }
        
        .menu-ui a:last-child {
            border: none;
            border-radius: 0 0 3px 3px;
        }
        
        .menu-ui a:hover {
            background: #f8f8f8;
            color: #404040;
        }
        
        .menu-ui a.active {
            background: #3887BE;
            color: #FFF;
        }
        
        .menu-ui a.active:hover {
            background: #3074a4;
        }
    </style>

</head>

<body>

    <nav id='menu-ui' class='menu-ui'></nav>
    <div id='map'></div>
    <div id="ui-slider">
        <input type="range" min=".1" , max="3" , value=".3" , step=".01" class="slider">
    </div>
    <div id="multiplier">Symbol Size</div>
    <div id="legend">
        <h3>Energy Sources, 2009</h3>
        <svg class="legend" width="200" height="200"></svg>
    </div>


    <script>
        L.mapbox.accessToken = 'pk.eyJ1IjoiaGFsbGllbGl1IiwiYSI6ImNpbnFhMGQwNDAwZWZ3N2tsMjMxa3RxNGkifQ.dJnzRSGnzwTOJduI5IEeJA';

        var map = L.mapbox.map('map', 'mapbox.light', {
            center: [-.23, 37.8],
            zoom: 6,
            minZoom: 6,
            maxZoom: 9,
            maxBounds: L.latLngBounds([-6.22, 27.72], [5.76, 47.83])
        });

        var controlLayers = document.getElementById('menu-ui');

        var radiusMultiplier = .3,
            electricity,
            p_lamp,
            lantern,
            tin_lamp,
            gas_lamp,
            wood,
            solar,
            other;
        
        var layers = document.getElementById('menu-ui');

        //var counties = omnivore.geojson('population-kenya-counties-2009.geojson').addTo(map);
        var energy = omnivore.csv('lighting-energy-kenya-counties-2009.csv')
            .on('ready', function (e) {
                drawMap(e.target.toGeoJSON())
            })
            .on('error', function (e) {
                console.log(e.error[0].message);
            });
        //.addTo(map);      ****** the drawMap() function now adds the data to the map *****

        //console.log(energy);

        sequenceUI();



        function drawMap(energyData) {

            electricity = L.geoJson(energyData, {
                pointToLayer: function (feature, layer) {
                    return L.circleMarker(layer, {
                        color: '#D96D02',
                        opacity: 1,
                        weight: 2,
                        fillOpacity: 0,
                        //radius: calcRadius(Number(feature.properties.electricity))
                    });
                }
            }).addTo(map);

            p_lamp = L.geoJson(energyData, {
                pointToLayer: function (feature, layer) {
                    return L.circleMarker(layer, {
                        color: '#1cce58',
                        opacity: 1,
                        weight: 2,
                        fillOpacity: 0,
                        //radius: calcRadius(Number(feature.properties.p_lamp))
                    });
                }
            });

            lantern = L.geoJson(energyData, {
                pointToLayer: function (feature, layer) {
                    return L.circleMarker(layer, {
                        color: '#1d198d',
                        opacity: 1,
                        weight: 2,
                        fillOpacity: 0,
                        //radius: calcRadius(Number(feature.properties.lantern))
                    });
                }
            });

            tin_lamp = L.geoJson(energyData, {
                pointToLayer: function (feature, layer) {
                    return L.circleMarker(layer, {
                        color: '#a0408d',
                        opacity: 1,
                        weight: 2,
                        fillOpacity: 0,
                        //radius: calcRadius(Number(feature.properties.tin_lamp))
                    });
                }
            });

            gas_lamp = L.geoJson(energyData, {
                pointToLayer: function (feature, layer) {
                    return L.circleMarker(layer, {
                        color: '#cf4c1f',
                        opacity: 1,
                        weight: 2,
                        fillOpacity: 0,
                        //radius: calcRadius(Number(feature.properties.gas_lamp))
                    });
                }
            });

            wood = L.geoJson(energyData, {
                pointToLayer: function (feature, layer) {
                    return L.circleMarker(layer, {
                        color: '#3b7326',
                        opacity: 1,
                        weight: 2,
                        fillOpacity: 0,
                        //radius: calcRadius(Number(feature.properties.wood))
                    });
                }
            });

            solar = L.geoJson(energyData, {
                pointToLayer: function (feature, layer) {
                    return L.circleMarker(layer, {
                        color: '#e6ab02',
                        opacity: 1,
                        weight: 2,
                        fillOpacity: 0,
                        //radius: calcRadius(Number(feature.properties.Solar))
                    });
                }
            }).addTo(map);

            other = L.geoJson(energyData, {
                pointToLayer: function (feature, layer) {
                    return L.circleMarker(layer, {
                        color: '#1a7acc',
                        opacity: 1,
                        weight: 2,
                        fillOpacity: 0,
                        //radius: calcRadius(Number(feature.properties.other))
                    });
                }
            }).addTo(map);
            
            var flameEnergy = L.layerGroup([p_lamp, lantern, tin_lamp, gas_lamp, wood]).addTo(map);
            var flameLayers = {
                "Kerosene": p_lamp,
                "Candles": lantern,
                "Biofuel": tin_lamp,
                "Gas": gas_lamp,
                "Wood": wood
            };
            
            addLayer(electricity, 'Electricity', 1);
            addLayer(solar, 'Solar', 2);
            addLayer(flameEnergy, 'Flame-based', 3);
            
            var radioControls = L.control.layers(null, flameLayers ).addTo(map);


            updateSymbols();

            //console.log(energyData);
        }

        function calcRadius(val) {
            var radius = Math.sqrt(val / Math.PI);
            return radius * radiusMultiplier;
        }

        function updateSymbols() {

            var radius, // variable to hold each radius
                allRadii = []; // empty array to hold all values

            electricity.eachLayer(function (layer) {
                radius = calcRadius(Number(layer.feature.properties.electricity));
                layer.setRadius(radius);
                allRadii.push(radius); // push radius value into the array
            });

            p_lamp.eachLayer(function (layer) {
                radius = calcRadius(Number(layer.feature.properties.p_lamp));
                layer.setRadius(radius);
                allRadii.push(radius);
            });

            lantern.eachLayer(function (layer) {
                radius = calcRadius(Number(layer.feature.properties.lantern));
                layer.setRadius(radius);
                allRadii.push(radius);
            });

            tin_lamp.eachLayer(function (layer) {
                radius = calcRadius(Number(layer.feature.properties.tin_lamp));
                layer.setRadius(radius);
                allRadii.push(radius);
            });

            gas_lamp.eachLayer(function (layer) {
                radius = calcRadius(Number(layer.feature.properties.gas_lamp));
                layer.setRadius(radius);
                allRadii.push(radius);
            });

            wood.eachLayer(function (layer) {
                radius = calcRadius(Number(layer.feature.properties.wood));
                layer.setRadius(radius);
                allRadii.push(radius);
            });

            solar.eachLayer(function (layer) {
                radius = calcRadius(Number(layer.feature.properties.Solar));
                layer.setRadius(radius);
                allRadii.push(radius);
            });

            other.eachLayer(function (layer) {
                radius = calcRadius(Number(layer.feature.properties.other));
                layer.setRadius(radius);
                allRadii.push(radius);
            });

            drawLegend(allRadii);
        }

        function sequenceUI() {

            //var output = $('#multiplier span');

            $('.slider')
                .on('input change', function () {
                    radiusMultiplier = $(this).val();
                    updateSymbols();
                    //output.html(radiusMultiplier);
                });
        }

        function drawLegend(allRadii) {

            var legend = $('.legend');

            var circles = {
                max: ss.max(allRadii),
                median: ss.median(allRadii),
                min: ss.min(allRadii)
            }

            var svgCircles = '';

            var reverseCalc = function (radius) {
                return Math.round((Math.pow(radius / radiusMultiplier, 2) * Math.PI));
            }

            for (var circle in circles) {

                svgCircles += '<circle cx="' + 100 + '" cy="' + (circles[circle] - 180) * -1 + '" r="' + circles[circle] + '" stroke="#d3d3d3" stroke-width="1" fill="ghostwhite" />';

                svgCircles += '<text x="' + 80 + '" y = "' + (circles[circle] - 160) * -1 + '" fill= "green">' + reverseCalc(circles[circle]) + '</text>'
            }

            legend.html(svgCircles)

        }

        function addLayer(layer, name, zIndex) {
            layer
                .setZIndex(zIndex)
                .addTo(map);

            // Create a simple layer switcher that
            // toggles layers on and off.
            var link = document.createElement('a');
            link.href = '#';
            link.className = 'active';
            link.innerHTML = name;

            link.onclick = function (e) {
                e.preventDefault();
                e.stopPropagation();

                if (map.hasLayer(layer)) {
                    map.removeLayer(layer);
                    this.className = '';
                } else {
                    map.addLayer(layer);
                    this.className = 'active';
                }
            };

            layers.appendChild(link);
        }
    </script>

</body>

</html>